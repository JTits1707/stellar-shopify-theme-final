{% comment %}
  Stellar Reverb Enhanced Collection Template
  Cosmic Product Vault with Advanced Filtering and Signal Seekers Integration
{% endcomment %}

{% assign collection_handle = collection.handle | default: 'all' %}
{% assign products_per_page = 12 %}

<div class="cosmic-bg"></div>
<div class="geometric-pulse"></div>
<div class="geometric-pulse"></div>
<div class="constellation"></div>

<main class="container mx-auto px-6 py-12">
  <section class="text-center mb-16">
    <h1 class="text-5xl font-bold mb-4 cosmic-title">
      COSMIC PRODUCT VAULT
    </h1>
    <p class="text-xl text-gray-300 mb-8">
      Shop All Transmissions &bull; Every Capsule &bull; All Frequencies
    </p>
  </section>

  {% comment %} Featured Transmission Section {% endcomment %}
  <section class="featured-transmission">
    {% assign featured_product = collections.featured.products.first | default: collection.products.first %}
    
    <div class="featured-image">
      {% if featured_product.featured_image %}
        {{ featured_product.featured_image | image_url: width: 400 | image_tag: 
           alt: featured_product.title, 
           class: 'w-full h-full object-cover rounded-lg' }}
      {% else %}
        <i class="fas fa-atom"></i>
      {% endif %}
    </div>
    
    <div class="featured-content">
      <h2>// FEATURED TRANSMISSION: {{ featured_product.title | upcase | default: 'ECHO CHAMBER ARTIFACT' }} //</h2>
      <p class="featured-lore">
        {% if featured_product.description != blank %}
          {{ featured_product.description | strip_html | truncate: 200 }}
        {% else %}
          Decoded fragment from Capsule 007: An infinite recursive pattern containing compressed consciousness data. Each fractal contains universes of experience. Handle with care - temporal distortions may occur during extended exposure.
        {% endif %}
      </p>
      {% if featured_product %}
        <a href="{{ featured_product.url }}" class="decode-btn">
          [ DECODE TRANSMISSION ]
        </a>
      {% else %}
        <button class="decode-btn">[ DECODE TRANSMISSION ]</button>
      {% endif %}
    </div>
  </section>

  {% comment %} Filtering Section {% endcomment %}
  <section class="mb-12">
    <div class="section-header">// TUNE FREQUENCY: CAPSULES //</div>
    <div class="flex flex-wrap justify-center gap-4 mb-8 filter-pills">
      <button class="filter-pill active" data-filter="all">All Transmissions</button>
      
      {% comment %} Generate capsule filters from product tags {% endcomment %}
      {% assign capsule_tags = '' %}
      {% for product in collection.products %}
        {% for tag in product.tags %}
          {% if tag contains 'capsule-' %}
            {% assign capsule_number = tag | remove: 'capsule-' %}
            {% unless capsule_tags contains capsule_number %}
              {% assign capsule_tags = capsule_tags | append: capsule_number | append: ',' %}
            {% endunless %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      
      {% assign capsule_array = capsule_tags | split: ',' %}
      {% for capsule in capsule_array %}
        {% unless capsule == blank %}
          <button class="filter-pill" data-filter="capsule-{{ capsule }}">
            Capsule {{ capsule | upcase }}
          </button>
        {% endunless %}
      {% endfor %}
      
      <button class="filter-pill" data-filter="signal-seeker">Signal Seeker Exclusives</button>
    </div>
    
    <div class="section-header">// ISOLATE SIGNAL: VISUAL MOTIFS //</div>
    <div class="flex flex-wrap justify-center gap-3 mb-6">
      <button class="motif-tag" data-tag="cassette-glyph">
        <i class="fas fa-cassette-tape mr-1"></i>Cassette Glyph
      </button>
      <button class="motif-tag" data-tag="fractal-echo">
        <i class="fas fa-atom mr-1"></i>Fractal Echo
      </button>
      <button class="motif-tag" data-tag="mythic-tech">
        <i class="fas fa-satellite mr-1"></i>Mythic Tech
      </button>
      <button class="motif-tag" data-tag="glitch-oracle">
        <i class="fas fa-eye mr-1"></i>Glitch Oracle
      </button>
    </div>

    <div class="section-header">SORT BY:</div>
    <div class="flex flex-wrap justify-center gap-3">
      <button class="sort-pill active" data-sort="resonant">Most Resonant</button>
      <button class="sort-pill" data-sort="created">Recently Decoded</button>
      <button class="sort-pill" data-sort="price-desc">Signal Strength: High to Low</button>
      <button class="sort-pill" data-sort="price-asc">Signal Strength: Low to High</button>
    </div>
  </section>

  {% comment %} Product Grid {% endcomment %}
  <section class="mb-16">
    <div class="product-grid" id="product-grid">
      {% paginate collection.products by products_per_page %}
        {% for product in collection.products %}
          {% assign capsule_tag = '' %}
          {% assign motif_tags = '' %}
          {% assign resonance_score = 85 %}
          
          {% comment %} Extract capsule and motif tags {% endcomment %}
          {% for tag in product.tags %}
            {% if tag contains 'capsule-' %}
              {% assign capsule_tag = tag %}
            {% elsif tag contains 'resonance-' %}
              {% assign resonance_score = tag | remove: 'resonance-' | plus: 0 %}
            {% else %}
              {% assign motif_tags = motif_tags | append: tag | append: ',' %}
            {% endif %}
          {% endfor %}
          
          {% comment %} Determine stock status {% endcomment %}
          {% assign stock_status = 'IN STOCK' %}
          {% assign stock_class = 'limited-badge' %}
          
          {% if product.available == false %}
            {% assign stock_status = 'SOLD OUT' %}
          {% elsif product.variants.first.inventory_quantity <= 3 and product.variants.first.inventory_quantity > 0 %}
            {% assign stock_status = product.variants.first.inventory_quantity | append: ' LEFT' %}
          {% elsif product.tags contains 'limited-edition' %}
            {% assign stock_status = 'LIMITED' %}
          {% elsif product.tags contains 'new' %}
            {% assign stock_status = 'NEW' %}
          {% elsif product.tags contains 'popular' %}
            {% assign stock_status = 'POPULAR' %}
          {% endif %}

          <div class="product-card" 
               data-capsule="{{ capsule_tag }}" 
               data-tags="{{ motif_tags | remove_last: ',' }}" 
               data-price="{{ product.price | money_without_currency | remove: ',' }}" 
               data-resonant="{{ resonance_score }}"
               data-created="{{ product.created_at | date: '%s' }}">
            
            {% comment %} Capsule Tag {% endcomment %}
            <div class="capsule-tag">
              {% if capsule_tag != blank %}
                {{ capsule_tag | remove: 'capsule-' | upcase }} &bull; 
              {% endif %}
              {% if product.metafields.custom.capsule_subtitle %}
                {{ product.metafields.custom.capsule_subtitle }}
              {% else %}
                Cosmic Transmission
              {% endif %}
            </div>
            
            {% comment %} Product Image {% endcomment %}
            <div class="h-48 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg mb-4 flex items-center justify-center relative product-image">
              {% if product.featured_image %}
                {{ product.featured_image | image_url: width: 400 | image_tag: 
                   alt: product.title, 
                   class: 'w-full h-full object-cover rounded-lg',
                   loading: 'lazy' }}
              {% else %}
                {% comment %} Default icon based on product type {% endcomment %}
                {% case product.type %}
                  {% when 'Hoodie', 'T-Shirt', 'Apparel' %}
                    <i class="fas fa-tshirt text-4xl opacity-50"></i>
                  {% when 'Poster', 'Print' %}
                    <i class="fas fa-image text-4xl opacity-50"></i>
                  {% when 'Mug', 'Drinkware' %}
                    <i class="fas fa-mug-hot text-4xl opacity-50"></i>
                  {% when 'Pin', 'Accessory' %}
                    <i class="fas fa-star text-4xl opacity-50"></i>
                  {% else %}
                    <i class="fas fa-waveform-lines text-4xl opacity-50"></i>
                {% endcase %}
              {% endif %}
            </div>
            
            {% comment %} Product Info {% endcomment %}
            <h3 class="text-xl font-bold mb-2 product-title">{{ product.title }}</h3>
            <p class="text-gray-400 text-sm mb-3 product-description">
              {% if product.description != blank %}
                {{ product.description | strip_html | truncate: 120 }}
              {% else %}
                Transmission from the cosmic void. Handle with care - reality distortions may occur.
              {% endif %}
            </p>
            
            {% comment %} Price and Stock {% endcomment %}
            <div class="flex justify-between items-center">
              <span class="text-2xl font-bold text-cyan-400">
                {{ product.price | money }}
              </span>
              <span class="{{ stock_class }}">{{ stock_status }}</span>
            </div>
            
            {% comment %} Quick Add Button {% endcomment %}
            <form action="/cart/add" method="post" enctype="multipart/form-data" class="mt-4">
              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
              <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-2 px-4 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-300 font-orbitron font-bold text-sm">
                <i class="fas fa-satellite-dish mr-2"></i>
                ADD TO TRANSMISSION
              </button>
            </form>
          </div>
        {% endfor %}
        
        {% comment %} Pagination {% endcomment %}
        {% if paginate.pages > 1 %}
          <div class="col-span-full flex justify-center mt-12">
            <nav class="pagination">
              {% if paginate.previous %}
                <a href="{{ paginate.previous.url }}" class="pagination-btn">
                  <i class="fas fa-chevron-left"></i> Previous
                </a>
              {% endif %}
              
              {% for part in paginate.parts %}
                {% if part.is_link %}
                  <a href="{{ part.url }}" class="pagination-btn">{{ part.title }}</a>
                {% else %}
                  <span class="pagination-btn active">{{ part.title }}</span>
                {% endif %}
              {% endfor %}
              
              {% if paginate.next %}
                <a href="{{ paginate.next.url }}" class="pagination-btn">
                  Next <i class="fas fa-chevron-right"></i>
                </a>
              {% endif %}
            </nav>
          </div>
        {% endif %}
      {% endpaginate %}
    </div>
  </section>

  {% comment %} Signal Seekers Section {% endcomment %}
  <section class="signal-seekers-section">
    <div class="text-center mb-8">
      <h2 class="text-4xl font-bold mb-4 signal-seekers-title">
        BECOME A SIGNAL SEEKER
      </h2>
      <p class="text-xl text-gray-300 italic">THE TRUTH IS ENCODED IN THE STATIC.</p>
    </div>

    <div class="benefit-grid">
      <div class="benefit-box">
        <div class="benefit-icon">
          <i class="fas fa-bolt"></i>
        </div>
        <div class="benefit-text">RECEIVE TRANSMISSIONS BEFORE THEY HIT THE PUBLIC FREQUENCY</div>
      </div>
      <div class="benefit-box">
        <div class="benefit-icon">
          <i class="fas fa-gem"></i>
        </div>
        <div class="benefit-text">UNLOCK ACCESS TO CLASSIFIED, SEEKER-ONLY RELICS</div>
      </div>
      <div class="benefit-box">
        <div class="benefit-icon">
          <i class="fas fa-scroll"></i>
        </div>
        <div class="benefit-text">DECODE ENCRYPTED LORE & BEHIND-THE-VEIL UPDATES</div>
      </div>
      <div class="benefit-box">
        <div class="benefit-icon">
          <i class="fas fa-gift"></i>
        </div>
        <div class="benefit-text">RECEIVE YOUR INITIATION KIT (10% OFF YOUR FIRST ARTIFACT)</div>
      </div>
    </div>

    {% comment %} Newsletter Signup Form {% endcomment %}
    <div class="signal-form">
      <form action="{{ routes.root_url }}contact#contact_form" method="post" id="contact_form" accept-charset="UTF-8" class="flex gap-4 justify-center items-center flex-wrap">
        <input type="hidden" name="form_type" value="customer" />
        <input type="hidden" name="utf8" value="✓" />
        <input type="hidden" name="contact[tags]" value="signal-seeker,newsletter">
        
        <input 
          type="email" 
          name="contact[email]"
          class="signal-input" 
          placeholder="Enter your comms channel (email)..."
          aria-label="Email for Signal Seekers subscription"
          required
        >
        <button type="submit" class="initiate-btn">
          [ ESTABLISH CONNECTION ]
        </button>
      </form>
    </div>
  </section>
</main>

{% comment %} Enhanced Styles {% endcomment %}
<style>
  :root {
    --neon-magenta: #E13CFA;
    --cyan-blue: #28A8D6;
    --void-black: #0D0D0D;
    --cosmic-purple: #6C24B3;
    --radioactive-green: #00F0AC;
    --electric-yellow: #FFE135;
  }

  .cosmic-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 80%, var(--cosmic-purple) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--cyan-blue) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, var(--neon-magenta) 0%, transparent 50%);
    opacity: 0.1;
    z-index: -1;
    animation: cosmic-drift 20s ease-in-out infinite;
  }

  .geometric-pulse {
    position: fixed;
    width: 100px;
    height: 100px;
    border: 2px solid var(--neon-magenta);
    border-radius: 50%;
    top: 20%;
    right: 10%;
    opacity: 0.3;
    animation: pulse 4s ease-in-out infinite;
    z-index: -1;
  }

  .geometric-pulse:nth-child(2) {
    width: 150px;
    height: 150px;
    border-color: var(--cyan-blue);
    top: 60%;
    left: 5%;
    animation-delay: 2s;
  }

  .constellation {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: -1;
  }

  .constellation::before {
    content: '';
    position: absolute;
    width: 2px;
    height: 2px;
    background: var(--cyan-blue);
    border-radius: 50%;
    top: 20%;
    left: 30%;
    animation: twinkle 3s ease-in-out infinite;
    box-shadow: 
      100px 50px 0 var(--electric-yellow),
      200px 100px 0 var(--neon-magenta),
      -50px 150px 0 var(--radioactive-green),
      150px 200px 0 var(--cyan-blue),
      300px 80px 0 var(--cosmic-purple);
  }

  .cosmic-title {
    font-family: 'Orbitron', monospace;
    background: linear-gradient(135deg, var(--neon-magenta), var(--cyan-blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .featured-transmission {
    background: linear-gradient(135deg, rgba(0, 240, 172, 0.1), rgba(40, 168, 214, 0.1));
    border: 2px solid var(--radioactive-green);
    border-radius: 20px;
    padding: 40px;
    margin: 60px 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    align-items: center;
    position: relative;
    overflow: hidden;
  }

  .featured-transmission::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(from 0deg, transparent, var(--radioactive-green), transparent);
    opacity: 0.1;
    animation: rotate 6s linear infinite;
    z-index: -1;
  }

  .featured-image {
    background: linear-gradient(135deg, var(--cosmic-purple), var(--neon-magenta));
    border-radius: 15px;
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .featured-image i {
    font-size: 4rem;
    color: white;
    opacity: 0.7;
    animation: pulse 3s ease-in-out infinite;
  }

  .featured-content h2 {
    font-family: 'Orbitron', monospace;
    font-size: 1.5rem;
    color: var(--radioactive-green);
    margin-bottom: 20px;
    letter-spacing: 1px;
  }

  .featured-lore {
    color: #ccc;
    line-height: 1.6;
    margin-bottom: 25px;
    font-style: italic;
  }

  .decode-btn {
    background: linear-gradient(135deg, var(--radioactive-green), var(--cyan-blue));
    color: var(--void-black);
    border: none;
    padding: 12px 25px;
    border-radius: 25px;
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 0 20px rgba(0, 240, 172, 0.3);
    text-decoration: none;
    display: inline-block;
  }

  .decode-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(0, 240, 172, 0.5);
    background: linear-gradient(135deg, var(--electric-yellow), var(--radioactive-green));
  }

  .section-header {
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    color: var(--neon-magenta);
    text-align: center;
    margin: 30px 0 20px 0;
    font-size: 1.2rem;
    letter-spacing: 2px;
  }

  .filter-pill, .motif-tag, .sort-pill {
    transition: all 0.3s ease;
    cursor: pointer;
    font-family: 'Orbitron', monospace;
  }

  .filter-pill {
    background: rgba(108, 36, 179, 0.3);
    border: 2px solid var(--cosmic-purple);
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    font-weight: 500;
  }

  .filter-pill:hover, .filter-pill.active {
    background: var(--cosmic-purple);
    box-shadow: 0 0 20px var(--cosmic-purple);
    transform: translateY(-2px);
  }

  .motif-tag {
    background: rgba(0, 240, 172, 0.2);
    border: 1px solid var(--radioactive-green);
    color: var(--radioactive-green);
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
  }

  .motif-tag:hover, .motif-tag.active {
    background: var(--radioactive-green);
    color: var(--void-black);
    box-shadow: 0 0 15px var(--radioactive-green);
  }

  .sort-pill {
    background: rgba(40, 168, 214, 0.2);
    border: 1px solid var(--cyan-blue);
    color: var(--cyan-blue);
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
  }

  .sort-pill:hover, .sort-pill.active {
    background: var(--cyan-blue);
    color: var(--void-black);
    box-shadow: 0 0 15px var(--cyan-blue);
  }

  .product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
    margin: 40px 0;
  }

  .product-card {
    background: rgba(108, 36, 179, 0.1);
    border: 1px solid var(--cosmic-purple);
    border-radius: 15px;
    padding: 20px;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .product-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(from 0deg, transparent, var(--neon-magenta), transparent);
    opacity: 0;
    animation: rotate 4s linear infinite;
    z-index: -1;
  }

  .product-card:hover::before {
    opacity: 0.1;
  }

  .product-card:hover {
    transform: translateY(-10px) rotateY(5deg);
    box-shadow: 0 20px 40px rgba(225, 60, 250, 0.3),
                0 0 30px rgba(40, 168, 214, 0.2);
    border-color: var(--neon-magenta);
    filter: brightness(1.1) contrast(1.05);
  }

  .capsule-tag {
    background: linear-gradient(135deg, var(--neon-magenta), var(--cosmic-purple));
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    position: absolute;
    top: -10px;
    left: 10px;
    z-index: 10;
  }

  .limited-badge {
    background: var(--electric-yellow);
    color: var(--void-black);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    animation: glow 2s ease-in-out infinite;
  }

  .product-title {
    font-family: 'Orbitron', monospace;
  }

  .signal-seekers-section {
    background: linear-gradient(135deg, rgba(108, 36, 179, 0.2), rgba(225, 60, 250, 0.1));
    border: 1px solid var(--cosmic-purple);
    border-radius: 20px;
    padding: 40px;
    margin: 60px 0;
    position: relative;
    overflow: hidden;
  }

  .signal-seekers-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 240, 172, 0.1), transparent);
    animation: scan 3s ease-in-out infinite;
  }

  .signal-seekers-title {
    font-family: 'Orbitron', monospace;
    color: var(--neon-magenta);
  }

  .benefit-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 40px 0;
  }

  .benefit-box {
    background: rgba(40, 168, 214, 0.1);
    border: 1px solid var(--cyan-blue);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
  }

  .benefit-box:hover {
    background: rgba(40, 168, 214, 0.2);
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(40, 168, 214, 0.3);
  }

  .benefit-icon {
    font-size: 2rem;
    color: var(--cyan-blue);
    margin-bottom: 15px;
  }

  .benefit-text {
    font-family: 'Orbitron', monospace;
    font-weight: 600;
    color: white;
  }

  .signal-form {
    display: flex;
    gap: 15px;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 30px;
  }

  .signal-input {
    flex: 1;
    min-width: 300px;
    background: rgba(13, 13, 13, 0.8);
    border: 2px solid var(--cosmic-purple);
    color: white;
    padding: 15px 20px;
    border-radius: 30px;
    font-family: 'Orbitron', monospace;
    outline: none;
    transition: all 0.3s ease;
  }

  .signal-input:focus {
    border-color: var(--neon-magenta);
    box-shadow: 0 0 20px rgba(225, 60, 250, 0.3);
  }

  .initiate-btn {
    background: linear-gradient(135deg, var(--neon-magenta), var(--cosmic-purple));
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 30px;
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .initiate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(225, 60, 250, 0.4);
    background: linear-gradient(135deg, var(--cyan-blue), var(--neon-magenta));
  }

  .pagination {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .pagination-btn {
    background: rgba(108, 36, 179, 0.3);
    border: 1px solid var(--cosmic-purple);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    text-decoration: none;
    font-family: 'Orbitron', monospace;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }

  .pagination-btn:hover, .pagination-btn.active {
    background: var(--cosmic-purple);
    box-shadow: 0 0 15px var(--cosmic-purple);
    transform: translateY(-2px);
  }

  /* Animations */
  @keyframes pulse {
    0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.3; }
    50% { transform: scale(1.2) rotate(180deg); opacity: 0.6; }
  }

  @keyframes twinkle {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.5); }
  }

  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes glow {
    0%, 100% { box-shadow: 0 0 5px var(--electric-yellow); }
    50% { box-shadow: 0 0 15px var(--electric-yellow), 0 0 25px var(--electric-yellow); }
  }

  @keyframes scan {
    0% { left: -100%; }
    50% { left: 100%; }
    100% { left: -100%; }
  }

  @keyframes cosmic-drift {
    0%, 100% { transform: scale(1) rotate(0deg); }
    50% { transform: scale(1.1) rotate(180deg); }
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .featured-transmission {
      grid-template-columns: 1fr;
      text-align: center;
    }
    
    .filter-pills {
      overflow-x: auto;
      padding: 10px 0;
    }
    
    .product-grid {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    
    .benefit-grid {
      grid-template-columns: 1fr;
    }
    
    .signal-form {
      flex-direction: column;
    }
    
    .signal-input {
      min-width: 100%;
    }
  }
</style>

{% comment %} Enhanced JavaScript {% endcomment %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const productGrid = document.getElementById('product-grid');
  const productCards = Array.from(productGrid.querySelectorAll('.product-card'));
  
  let currentCapsuleFilter = 'all';
  let currentTagFilter = 'all';
  let currentSort = 'resonant';

  // Create constellation dots
  createConstellation();

  // --- FILTERING LOGIC ---
  const filterPills = document.querySelectorAll('.filter-pill');
  filterPills.forEach(pill => {
    pill.addEventListener('click', () => {
      filterPills.forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      currentCapsuleFilter = pill.dataset.filter;
      applyFilters();
    });
  });

  const motifTags = document.querySelectorAll('.motif-tag');
  motifTags.forEach(tag => {
    tag.addEventListener('click', () => {
      if (tag.classList.contains('active')) {
        tag.classList.remove('active');
        currentTagFilter = 'all';
      } else {
        motifTags.forEach(t => t.classList.remove('active'));
        tag.classList.add('active');
        currentTagFilter = tag.dataset.tag;
      }
      applyFilters();
    });
  });

  function applyFilters() {
    productCards.forEach(card => {
      const capsuleMatch = currentCapsuleFilter === 'all' || 
                          card.dataset.capsule === currentCapsuleFilter ||
                          (currentCapsuleFilter === 'signal-seeker' && card.dataset.tags.includes('signal-seeker'));
      
      const tagMatch = currentTagFilter === 'all' || 
                      card.dataset.tags.includes(currentTagFilter);

      if (capsuleMatch && tagMatch) {
        card.style.display = 'block';
        card.style.animation = 'fadeInUp 0.5s ease-out';
      } else {
        card.style.display = 'none';
      }
    });
  }

  // --- SORTING LOGIC ---
  const sortPills = document.querySelectorAll('.sort-pill');
  sortPills.forEach(pill => {
    pill.addEventListener('click', () => {
      sortPills.forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      currentSort = pill.dataset.sort;
      sortProducts(currentSort);
    });
  });

  function sortProducts(criteria) {
    let sortedCards = [...productCards];

    switch (criteria) {
      case 'resonant':
        sortedCards.sort((a, b) => b.dataset.resonant - a.dataset.resonant);
        break;
      case 'created':
        sortedCards.sort((a, b) => b.dataset.created - a.dataset.created);
        break;
      case 'price-desc':
        sortedCards.sort((a, b) => parseFloat(b.dataset.price) - parseFloat(a.dataset.price));
        break;
      case 'price-asc':
        sortedCards.sort((a, b) => parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
        break;
    }

    // Re-append sorted cards to the grid
    sortedCards.forEach(card => {
      productGrid.appendChild(card);
    });

    // Re-apply current filters
    applyFilters();
  }

  function createConstellation() {
    const constellation = document.querySelector('.constellation');
    const numStars = 20;

    for (let i = 0; i < numStars; i++) {
      const star = document.createElement('div');
      star.className = 'constellation-dot';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = Math.random() * 3 + 's';
      constellation.appendChild(star);
    }
  }

  // Add to cart with cosmic feedback
  const addToCartForms = document.querySelectorAll('form[action="/cart/add"]');
  addToCartForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const button = this.querySelector('button[type="submit"]');
      const originalText = button.innerHTML;
      
      button.innerHTML = '<i class="fas fa-satellite-dish fa-spin mr-2"></i>TRANSMITTING...';
      button.disabled = true;
      
      fetch('/cart/add.js', {
        method: 'POST',
        body: new FormData(this)
      })
      .then(response => response.json())
      .then(data => {
        button.innerHTML = '<i class="fas fa-check mr-2"></i>TRANSMITTED!';
        button.style.background = 'linear-gradient(135deg, var(--radioactive-green), var(--cyan-blue))';
        
        // Show cosmic notification
        showCosmicNotification('Item added to transmission!');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
          button.style.background = '';
        }, 2000);
      })
      .catch(error => {
        button.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>ERROR';
        button.style.background = 'linear-gradient(135deg, #ff4444, #cc0000)';
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
          button.style.background = '';
        }, 2000);
      });
    });
  });

  function showCosmicNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'cosmic-notification';
    notification.innerHTML = `
      <i class="fas fa-satellite-dish mr-2"></i>
      ${message}
    `;
    
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--neon-magenta), var(--cosmic-purple));
      color: white;
      padding: 15px 20px;
      border-radius: 25px;
      font-family: 'Orbitron', monospace;
      font-weight: 600;
      z-index: 10000;
      animation: slideInRight 0.5s ease-out;
      box-shadow: 0 10px 30px rgba(225, 60, 250, 0.4);
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.5s ease-out';
      setTimeout(() => notification.remove(), 500);
    }, 3000);
  }

  // Initialize with default sort
  sortProducts(currentSort);
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  .constellation-dot {
    position: absolute;
    width: 2px;
    height: 2px;
    background: var(--cyan-blue);
    border-radius: 50%;
    animation: twinkle 3s ease-in-out infinite;
  }
`;
document.head.appendChild(style);
</script>
